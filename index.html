<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Interactive Globe</title>

  <!-- Anti-flicker: set embed class BEFORE any CSS loads -->
  <script>
  (function () {
    var q = location.search || "";
    var isEmbed =
      q.includes("embed=1") ||
      (function(){ try { return self !== top; } catch(e){ return true; } })() ||
      /(?:^|[?&])(ui=0|noui=1)(?:&|$)/.test(q);
    if (isEmbed) document.documentElement.classList.add("embed");
  })();
  </script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.5/dist/sweetalert2.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Speed up first connections for textures & Firebase -->
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>

  <style>
    body { margin:0; overflow:hidden; font-family:'Inter',sans-serif; background-color:#000000; }
    #globeViz { width:100vw; height:100vh; position:relative; z-index:2; }

    .ui-container { position:absolute; top:10px; right:10px; display:flex; align-items:center; gap:10px; z-index:1000; }

    .search-bar-container { position:relative; display:flex; flex-direction:column; width:250px; }
    #search-input { padding:8px 12px; border-radius:8px; border:1px solid #ccc; box-shadow:0 4px 6px rgba(0,0,0,0.1); }
    #search-results { list-style:none; padding:0; margin:0; position:absolute; top:100%; width:100%; background:#fff; border:1px solid #ccc; border-top:none; border-radius:0 0 8px 8px; max-height:200px; overflow-y:auto; display:none; z-index:1001; box-shadow:0 8px 16px rgba(0,0,0,0.2); }
    #search-results li { padding:8px 12px; cursor:pointer; border-bottom:1px solid #eee; font-size:14px; }
    #search-results li:hover { background:#f0f0f0; }

    .marker-container { display:flex; flex-direction:column; align-items:center; cursor:pointer; }
    .marker-icon { width:40px; height:40px; border-radius:50%; border:3px solid #fff; transition:transform .2s, box-shadow .2s; }
    .marker-icon:hover { transform:scale(1.1); box-shadow:0 0 10px rgba(255,255,255,.7); }
    .marker-label { margin-top:2px; color:#2fe0ff; font-size:14px; font-weight:bold; text-align:center; text-shadow:0 0 5px #000, 0 0 10px #000; pointer-events:none; }

    /* NEW: special color for Top-30 labels (no dot) */
    .marker-label.top30 { color:#ffd166; } /* gold */

    #loading-spinner { display:none; }

    /* Comets behind globe & UI */
    .comet { position:fixed; width:2px; height:2px; background:#fff; border-radius:50%; box-shadow:0 0 5px rgba(255,255,255,0.8), 0 0 15px #a0ffff; z-index:1; pointer-events:none; opacity:0; transform:translate(var(--start-x), var(--start-y)); animation:comet-fly var(--duration) linear var(--delay) infinite; }
    .comet::before { content:''; position:absolute; top:50%; left:50%; width:150px; height:1px; background:linear-gradient(to right, rgba(255,255,255,0), rgba(160,255,255,0.8)); transform:translate(-100%,-50%) rotate(45deg); transform-origin:100% 50%; opacity:0.6; }
    @keyframes comet-fly { 0%{ transform:translate(var(--start-x), var(--start-y)); opacity:0; } 5%{ opacity:1; } 95%{ opacity:1; } 100%{ transform:translate(var(--end-x), var(--end-y)); opacity:0; } }

    /* ===== EMBED MODE: globe-only, transparent background ===== */
    html.embed body { background: transparent !important; }
    html.embed #globeViz { background: transparent !important; }

    /* Hide UI when embedded */
    html.embed .ui-container,
    html.embed .modal,
    html.embed #uploadControls,
    html.embed #search-results {
      visibility: hidden !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }
    html.embed .comet { display: none !important; }
  </style>
</head>
<body>

  <div id="globeViz"></div>

  <div class="ui-container">
    <div class="search-bar-container">
      <input type="text" id="search-input" placeholder="Search location..." class="form-control">
      <ul id="search-results"></ul>
    </div>

    <div id="uploadControls">
      <button type="button" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#uploadModal" title="Upload CSV file">
        <i class="fas fa-file-upload"></i> Upload
      </button>
    </div>

    <!-- Toggle the Top-30 layer (default ON) -->
    <button type="button" class="btn btn-outline-info" id="btnTop30" title="Toggle Top 30 Richest Cities">
      <i class="fa-solid fa-trophy"></i> Top 30
    </button>
  </div>

  <!-- Upload CSV Modal -->
  <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="uploadModalLabel">Upload Locations (CSV)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Select a CSV file. Make sure it has the columns <strong>city</strong>, <strong>lat</strong>, and <strong>lng</strong> (optional: <strong>country</strong>).</p>
          <input type="file" class="form-control" id="csvFile" accept=".csv">
          <div id="statusMessage" class="mt-3">Ready to upload.</div>
        </div>
        <div class="modal-footer">
          <span id="loading-spinner" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="uploadBtn">Upload</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Pin Modal -->
  <div class="modal fade" id="pinningModal" tabindex="-1" aria-labelledby="pinningModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="pinningModalLabel">Pin / Unpin Location</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="pinningModalText">Do you want to toggle the pin status?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="togglePinBtn">Pin</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Choose Brand Modal -->
  <div class="modal fade" id="brandModal" tabindex="-1" aria-labelledby="brandModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="brandModalLabel">Choose Brand for City</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="brandModalText">Which brand should be shown for this city?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="chooseUnpinBtn" style="display:none">Unpin</button>
          <button type="button" class="btn btn-dark" id="chooseFederationBtn">Federation</button>
          <button type="button" class="btn btn-primary" id="chooseAcademyBtn">Academy</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/globe.gl"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.5/dist/sweetalert2.min.js"></script>

  <!-- Initialize Firebase app (your existing config lives here) -->
  <script type="module" src="./firebase.js"></script>

  <!-- Ensure the browser is signed-in (Anonymous for dev) -->
  <script type="module">
    import {
      getAuth, signInAnonymously, onAuthStateChanged,
      setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

    const auth = getAuth();
    setPersistence(auth, browserLocalPersistence)
      .then(() => signInAnonymously(auth))
      .catch(err => console.error('[auth]', err?.code, err?.message));
    onAuthStateChanged(auth, (u) => console.log('[auth] UID:', u?.uid || '(none)'));
  </script>

  <!-- Hide Upload for non-admin or when embedded -->
  <script>
    (function(){
      const isEmbed = document.documentElement.classList.contains('embed');
      const isLocalhost = /^(localhost|127\.0\.0\.1|::1)$/.test(location.hostname);
      const isAdmin = isLocalhost || localStorage.getItem('yh_admin') === '1';
      const el = document.getElementById('uploadControls');
      if (el && (isEmbed || !isAdmin)) el.style.display = 'none';
    })();
  </script>

  <!-- App logic -->
  <script type="module" src="./main.js"></script>

  <!-- Inline JSON of Top 30 Richest Cities (labels only; no dots) -->
  <script id="top30RichestJSON" type="application/json">[{"city":"Tokyo","lat":35.687,"lng":139.7495,"country":"Japan"},{"city":"New York","lat":40.6943,"lng":-73.9249,"country":"United States"},{"city":"Los Angeles","lat":34.1141,"lng":-118.4068,"country":"United States"},{"city":"Seoul","lat":37.5667,"lng":126.9833,"country":"Korea, South"},{"city":"London","lat":51.5072,"lng":-0.1275,"country":"United Kingdom"},{"city":"Chicago","lat":41.8373,"lng":-87.6862,"country":"United States"},{"city":"Paris","lat":48.8566,"lng":2.3522,"country":"France"},{"city":"Shenzhen","lat":22.535,"lng":114.054,"country":"China"},{"city":"Osaka","lat":34.6939,"lng":135.5022,"country":"Japan"},{"city":"Shanghai","lat":31.1667,"lng":121.4667,"country":"China"},{"city":"Moscow","lat":55.7558,"lng":37.6178,"country":"Russia"},{"city":"Beijing","lat":39.905,"lng":116.3914,"country":"China"},{"city":"San Francisco","lat":37.7562,"lng":-122.443,"country":"United States"},{"city":"Guangzhou","lat":23.1288,"lng":113.259,"country":"China"},{"city":"Hong Kong","lat":22.35,"lng":114.2,"country":"Hong Kong"},{"city":"Dallas","lat":32.7936,"lng":-96.7662,"country":"United States"},{"city":"Philadelphia","lat":40.0076,"lng":-75.134,"country":"United States"},{"city":"Miami","lat":25.7839,"lng":-80.2102,"country":"United States"},{"city":"Boston","lat":42.3188,"lng":-71.0846,"country":"United States"},{"city":"Washington","lat":38.9047,"lng":-77.0163,"country":"United States"},{"city":"Singapore","lat":1.2897,"lng":103.8501,"country":"Singapore"},{"city":"Sydney","lat":-33.8696,"lng":151.2069,"country":"Australia"},{"city":"Toronto","lat":43.7417,"lng":-79.3733,"country":"Canada"},{"city":"Zurich","lat":47.377,"lng":8.54,"country":"Switzerland"},{"city":"San Jose","lat":37.302,"lng":-121.8488,"country":"United States"},{"city":"Houston","lat":29.784,"lng":-95.3455,"country":"United States"},{"city":"Munich","lat":48.1374,"lng":11.5755,"country":"Germany"},{"city":"Frankfurt","lat":50.1106,"lng":8.6822,"country":"Germany"},{"city":"Stockholm","lat":59.3294,"lng":18.0686,"country":"Sweden"},{"city":"Amsterdam","lat":52.374,"lng":4.8897,"country":"Netherlands"}]</script>
</body>
</html>
