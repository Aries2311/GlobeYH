<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Interactive Globe</title>

  <!-- Anti-flicker: set embed class BEFORE any CSS loads -->
  <script>
  (function () {
    var q = location.search || "";
    var isEmbed =
      q.includes("embed=1") ||
      (function(){ try { return self !== top; } catch(e){ return true; } })() ||
      /(?:^|[?&])(ui=0|noui=1)(?:&|$)/.test(q);
    if (isEmbed) document.documentElement.classList.add("embed");
  })();
  </script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.5/dist/sweetalert2.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Speed up first connections for textures & Firebase -->
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>

  <style>
    :root{
      /* color ng continent overlay labels (hindi ito brand labels) */
      --continent-overlay: #ffffff;
    }

    body { margin:0; overflow:hidden; font-family:'Inter',sans-serif; background:transparent !important; }

    html, body, #globeViz, canvas { background: transparent !important; }

    /* naka-embed = transparent din ang UI wrapper */
    html.embed body { background: transparent !important; }
    html.embed #globeViz { background: transparent !important; }

    #globeViz { width:100vw; height:100vh; position:relative; z-index:2; }

    .ui-container { position:absolute; top:10px; right:10px; display:flex; align-items:center; gap:10px; z-index:1000; }

    .search-bar-container { position:relative; display:flex; flex-direction:column; width:250px; }
    #search-input { padding:8px 12px; border-radius:8px; border:1px solid #ccc; box-shadow:0 4px 6px rgba(0,0,0,0.1); }
    #search-results { list-style:none; padding:0; margin:0; position:absolute; top:100%; width:100%; background:#fff; border:1px solid #ccc; border-top:none; border-radius:0 0 8px 8px; max-height:200px; overflow-y:auto; display:none; z-index:1001; box-shadow:0 8px 16px rgba(0,0,0,0.2); }
    #search-results li { padding:8px 12px; cursor:pointer; border-bottom:1px solid #eee; font-size:14px; }
    #search-results li:hover { background:#f0f0f0; }

    .marker-container { display:flex; flex-direction:column; align-items:center; cursor:pointer; }

    /* base look ng icon (white ring kapag walang brand) */
    .marker-icon { width:40px; height:40px; border-radius:50%; border:3px solid #fff; transition:transform .2s, box-shadow .2s; }
    .marker-icon:hover { transform:scale(1.1); box-shadow:0 0 10px rgba(255,255,255,.7); }

    /* default look ng brand label (ma-o-override ng brand-* classes sa ibaba) */
    .marker-label {
      margin-top:2px;
      color:#1e90ff;               /* default/fallback: Federation blue */
      font-size:14px;
      font-weight:bold;
      text-align:center;
      text-shadow:0 0 5px #000, 0 0 10px #000;
      pointer-events:none;
      white-space:nowrap;
    }

    /* ---- BRAND COLORS: label text ---- */
    .marker-label.brand-academy    { color:#d8d8d8; }  /* gray */
    .marker-label.brand-plaza      { color:#ff4d4f; }  /* red */
    .marker-label.brand-federation { color:#00fcda; }  /* blue */

    .marker-icon.brand-academy    { border-color:#d8d8d8; box-shadow:0 0 10px rgba(189,189,189,.45); }
    .marker-icon.brand-academy:hover { box-shadow:0 0 14px rgba(216, 216, 216, 0.9); }

    .marker-icon.brand-plaza      { border-color:#ff4d4f; box-shadow:0 0 10px rgba(255,77,79,.45); }
    .marker-icon.brand-plaza:hover   { box-shadow:0 0 14px rgba(255,77,79,.9); }

    .marker-icon.brand-federation { border-color:#00fcda; box-shadow:0 0 10px rgba(30,144,255,.45); }
    .marker-icon.brand-federation:hover { box-shadow:0 0 14px rgba(4, 252, 231, 0.9); }

    /* Legacy Top-30 fallback color (kept) */
    .marker-label.top30 { color:#ffd166; }

    /* Continent ×10 overlay labels (hindi brand) */
    .marker-label.richest {
      color: var(--continent-overlay);
      font-size:12px;
      text-shadow: 0 0 4px #000, 0 0 10px rgba(0,0,0,.85);
    }

    #loading-spinner { display:none; }

    /* ===== EMBED MODE ===== */
    html.embed body { background: transparent !important; }
    html.embed #globeViz { background: transparent !important; }
    html.embed .ui-container,
    html.embed .modal,
    html.embed #uploadControls,
    html.embed #search-results {
      visibility: hidden !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }
    html.embed .comet { display: none !important; }

    /* THINNER ring when embed/mobile (you already had this) */
    html.embed .marker-icon { border-width: 1px; }
    @media (max-width:768px){ .marker-icon { border-width: 1px; } }

    /* === NEW: MOBILE-ONLY smaller brand labels (pinned cities) === */
    @media (max-width:768px){
      .marker-label{
        font-size:8px;           /* from 14px -> 11px */
        line-height:1.05;
        margin-top:1px;
        text-shadow:0 0 3px #000, 0 0 7px rgba(0,0,0,.75);
      }
    }
  </style>
</head>
<body>

  <div id="globeViz"></div>

  <div class="ui-container">
    <div class="search-bar-container">
      <input type="text" id="search-input" placeholder="Search location..." class="form-control">
      <ul id="search-results"></ul>
    </div>

    <div id="uploadControls">
      <button type="button" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#uploadModal" title="Upload CSV file">
        <i class="fas fa-file-upload"></i> Upload
      </button>
    </div>

    <button type="button" class="btn btn-outline-info" id="btnRichest" title="Toggle Continents ×10 (10 countries per continent)">
      <i class="fa-solid fa-trophy"></i> Continents ×10
    </button>
  </div>

  <!-- Upload CSV Modal -->
  <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="uploadModalLabel">Upload Locations (CSV)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Select a CSV file. Make sure it has the columns <strong>city</strong>, <strong>lat</strong>, and <strong>lng</strong> (optional: <strong>country</strong>).</p>
          <input type="file" class="form-control" id="csvFile" accept=".csv">
          <div id="statusMessage" class="mt-3">Ready to upload.</div>
        </div>
        <div class="modal-footer">
          <span id="loading-spinner" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="uploadBtn">Upload</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Pin Modal -->
  <div class="modal fade" id="pinningModal" tabindex="-1" aria-labelledby="pinningModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="pinningModalLabel">Pin / Unpin Location</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="pinningModalText">Do you want to toggle the pin status?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="togglePinBtn">Pin</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Choose Brand Modal -->
  <div class="modal fade" id="brandModal" tabindex="-1" aria-labelledby="brandModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="brandModalLabel">Choose Brand for City</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="brandModalText">Which brand should be shown for this city?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="chooseUnpinBtn" style="display:none">Unpin</button>
          <button type="button" class="btn btn-dark" id="chooseFederationBtn">Federation</button>
          <button type="button" class="btn btn-primary" id="chooseAcademyBtn">Academy</button>
          <button type="button" class="btn btn-success" id="choosePlazaBtn">Plaza</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/globe.gl"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.5/dist/sweetalert2.min.js"></script>

  <!-- Initialize Firebase app -->
  <script type="module" src="./firebase.js"></script>

  <!-- Anonymous sign-in for dev -->
  <script type="module">
    import {
      getAuth, signInAnonymously, onAuthStateChanged,
      setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

    const auth = getAuth();
    setPersistence(auth, browserLocalPersistence)
      .then(() => signInAnonymously(auth))
      .catch(err => console.error('[auth]', err?.code, err?.message));
    onAuthStateChanged(auth, (u) => console.log('[auth] UID:', u?.uid || '(none)'));
  </script>

  <!-- Hide Upload for non-admin or when embedded -->
  <script>
    (function(){
      const isEmbed = document.documentElement.classList.contains('embed');
      const isLocalhost = /^(localhost|127\.0\.0\.1|::1)$/.test(location.hostname);
      const isAdmin = isLocalhost || localStorage.getItem('yh_admin') === '1';
      const el = document.getElementById('uploadControls');
      if (el && (isEmbed || !isAdmin)) el.style.display = 'none';
    })();
  </script>

  <!-- App logic -->
  <script type="module" src="./main.js"></script>

  <!-- Keep empty if CSV is used -->
  <script id="richestCitiesJSON" type="application/json">[]</script>

  <!-- Legacy inline JSON of Top 30 (fallback) -->
  <script id="top30RichestJSON" type="application/json">[{"city":"Tokyo","lat":35.687,"lng":139.7495,"country":"Japan"},{"city":"New York","lat":40.6943,"lng":-73.9249,"country":"United States"},{"city":"Los Angeles","lat":34.1141,"lng":-118.4068,"country":"United States"},{"city":"Seoul","lat":37.5667,"lng":126.9833,"country":"Korea, South"},{"city":"London","lat":51.5072,"lng":-0.1275,"country":"United Kingdom"},{"city":"Chicago","lat":41.8373,"lng":-87.6862,"country":"United States"},{"city":"Paris","lat":48.8566,"lng":2.3522,"country":"France"},{"city":"Shenzhen","lat":22.535,"lng":114.054,"country":"China"},{"city":"Osaka","lat":34.6939,"lng":135.5022,"country":"Japan"},{"city":"Shanghai","lat":31.1667,"lng":121.4667,"country":"China"},{"city":"Moscow","lat":55.7558,"lng":37.6178,"country":"Russia"},{"city":"Beijing","lat":39.905,"lng":116.3914,"country":"China"},{"city":"San Francisco","lat":37.7562,"lng":-122.443,"country":"United States"},{"city":"Guangzhou","lat":23.1288,"lng":113.259,"country":"China"},{"city":"Hong Kong","lat":22.35,"lng":114.2,"country":"Hong Kong"},{"city":"Dallas","lat":32.7936,"lng":-96.7662,"country":"United States"},{"city":"Philadelphia","lat":40.0076,"lng":-75.134,"country":"United States"},{"city":"Miami","lat":25.7839,"lng":-80.2102,"country":"United States"},{"city":"Boston","lat":42.3188,"lng":-71.0846,"country":"United States"},{"city":"Washington","lat":38.9047,"lng":-77.0163,"country":"United States"},{"city":"Singapore","lat":1.2897,"lng":103.8501,"country":"Singapore"},{"city":"Sydney","lat":-33.8696,"lng":151.2069,"country":"Australia"},{"city":"Toronto","lat":43.7417,"lng":-79.3733,"country":"Canada"},{"city":"Zurich","lat":47.377,"lng":8.54,"country":"Switzerland"},{"city":"San Jose","lat":37.302,"lng":-121.8488,"country":"United States"},{"city":"Houston","lat":29.784,"lng":-95.3455,"country":"United States"},{"city":"Munich","lat":48.1374,"lng":11.5755,"country":"Germany"},{"city":"Frankfurt","lat":50.1106,"lng":8.6822,"country":"Germany"},{"city":"Stockholm","lat":59.3294,"lng":18.0686,"country":"Sweden"},{"city":"Amsterdam","lat":52.374,"lng":4.8897,"country":"Netherlands"}]</script>
</body>
</html>
